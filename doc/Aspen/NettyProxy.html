<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=UTF-8" />
<title>Class: Aspen::NettyProxy</title>
<link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/app.js"></script>

  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (N)</a> &raquo; 
    <a href="../Aspen.html" title="Aspen">Aspen</a>
     &raquo; 
    <span class="title">NettyProxy</span>
  
</div>

      <div id="search">
  <a id="class_list_link" href="#">Namespace List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: Aspen::NettyProxy 
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2">RackProxy</dd>
      
    
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">lib/aspen/netty_proxy.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>
implementation of RackProxy interface from Java side
</p>


  </div>
</div>
<div class="tags">
  <h3>Author:</h3>
<ul class="author">
  
    <li>
      
      
      
      
        
        
Kevin Williams


      
    </li>
  
</ul>
<h3>Since:</h3>
<ul class="since">
  
    <li>
      
      
      
      
        
        
1.0.0


      
    </li>
  
</ul>
<h3>Version:</h3>
<ul class="version">
  
    <li>
      
      
      
      
        
        
1.0.0


      
    </li>
  
</ul>

</div>

  

  <h2>Method Summary</h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature"><a href="#initialize-instance_method" title="#initialize (instance method)">- (Array) <strong>initialize</strong>(app) </a>
  
  </span>
  
  
  
  

  
    <span class="summary_desc">
create new instance of NettyProxy.

</span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature"><a href="#process-instance_method" title="#process (instance method)">- (HttpResponse) <strong>process</strong>(cxt, req) </a>
  
  </span>
  
  
  
  

  
    <span class="summary_desc">
process an incoming message which has been received on the socket this
method does most of the heavy lifting of translating Netty classes and
behaviors into Rack.

</span>
  
</li>

    
  </ul>


  <div id="constructor_details">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <p class="signature first" id="initialize-instance_method">
  
    - (<tt>Array</tt>) <strong>initialize</strong>(app) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
create new instance of NettyProxy
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='type'>(<tt>env</tt>)</span>
      
      
        <span class='name'>#call</span>
      
      
      
        &mdash;
        
a Ruby Object which responds to :call(env)


      
    </li>
  
</ul>
<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
      
      
        &mdash;
        
an array of [Integer (status code), Hash (headers), and Object responding
to #each returning Strings]


      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


34
35
36</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/aspen/netty_proxy.rb', line 34</span>

<span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span><span class='lparen token'>(</span> <span class='app identifier id'>app</span> <span class='rparen token'>)</span>
  <span class='@app ivar id'>@app</span> <span class='assign token'>=</span> <span class='app identifier id'>app</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="method_details">
    <h2>Method Details</h2>
    
      <div class="method_details first">
  <p class="signature first" id="process-instance_method">
  
    - (<tt>HttpResponse</tt>) <strong>process</strong>(cxt, req) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
  <p class="note todo">
    <strong>TODO:</strong> 
    
handle chunking, keep-alive, content-encoding, etc.


  </p>

<p>
process an incoming message which has been received on the socket this
method does most of the heavy lifting of translating Netty classes and
behaviors into Rack
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='type'>(<tt>ChannelHandlerContext</tt>)</span>
      
      
        <span class='name'>the</span>
      
      
      
        &mdash;
        
Netty context for message handling


      
    </li>
  
    <li>
      
        <span class='type'>(<tt>HttpRequest</tt>)</span>
      
      
        <span class='name'>the</span>
      
      
      
        &mdash;
        
Netty request object


      
    </li>
  
</ul>
<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
        <span class='type'>(<tt>HttpResponse</tt>)</span>
      
      
      
      
        &mdash;
        
the Netty response


      
    </li>
  
</ul>
<h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
        <span class='type'>(<tt><a href="RackParseError.html" title="RackParseError">RackParseError</a></tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/aspen/netty_proxy.rb', line 44</span>

<span class='def def kw'>def</span> <span class='process identifier id'>process</span><span class='lparen token'>(</span> <span class='cxt identifier id'>cxt</span><span class='comma token'>,</span> <span class='req identifier id'>req</span> <span class='rparen token'>)</span>
  <span class='env identifier id'>env</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
  <span class='RackUtil constant id'>RackUtil</span><span class='dot token'>.</span><span class='parse_headers identifier id'>parse_headers</span><span class='lparen token'>(</span> <span class='cxt identifier id'>cxt</span><span class='comma token'>,</span> <span class='req identifier id'>req</span><span class='comma token'>,</span> <span class='env identifier id'>env</span> <span class='rparen token'>)</span>
  <span class='env identifier id'>env</span><span class='lbrack token'>[</span><span class='string val'>&quot;SCRIPT_NAME&quot;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='string val'>&quot;&quot;</span>  <span class='if if_mod kw'>if</span> <span class='env identifier id'>env</span><span class='lbrack token'>[</span><span class='string val'>&quot;SCRIPT_NAME&quot;</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='string val'>&quot;/&quot;</span>
  <span class='env identifier id'>env</span><span class='dot token'>.</span><span class='delete identifier id'>delete</span> <span class='string val'>&quot;PATH_INFO&quot;</span>  <span class='if if_mod kw'>if</span> <span class='env identifier id'>env</span><span class='lbrack token'>[</span><span class='string val'>&quot;PATH_INFO&quot;</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='string val'>&quot;&quot;</span>
  <span class='env identifier id'>env</span><span class='lbrack token'>[</span><span class='string val'>&quot;SERVER_PORT&quot;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='string val'>&quot;80&quot;</span> <span class='unless unless_mod kw'>unless</span> <span class='env identifier id'>env</span><span class='lbrack token'>[</span><span class='string val'>&quot;SERVER_PORT&quot;</span><span class='rbrack token'>]</span>
  <span class='data identifier id'>data</span> <span class='assign token'>=</span> <span class='req identifier id'>req</span><span class='dot token'>.</span><span class='content identifier id'>content</span><span class='dot token'>.</span><span class='to_string identifier id'>to_string</span><span class='lparen token'>(</span><span class='string val'>&quot;UTF-8&quot;</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span>
  <span class='rack_input identifier id'>rack_input</span> <span class='assign token'>=</span> <span class='StringIO constant id'>StringIO</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span> <span class='data identifier id'>data</span> <span class='rparen token'>)</span>
  <span class='rack_input identifier id'>rack_input</span><span class='dot token'>.</span><span class='set_encoding identifier id'>set_encoding</span><span class='lparen token'>(</span> <span class='Encoding constant id'>Encoding</span><span class='colon2 op'>::</span><span class='BINARY constant id'>BINARY</span> <span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='rack_input identifier id'>rack_input</span><span class='dot token'>.</span><span class='respond_to? fid id'>respond_to?</span><span class='lparen token'>(</span> <span class='symbol val'>:set_encoding</span> <span class='rparen token'>)</span>
  <span class='env identifier id'>env</span><span class='dot token'>.</span><span class='update identifier id'>update</span><span class='lparen token'>(</span> <span class='lbrace token'>{</span><span class='string val'>&quot;rack.version&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='colon3 op'>::</span><span class='Aspen constant id'>Aspen</span><span class='colon2 op'>::</span><span class='VERSION constant id'>VERSION</span><span class='colon2 op'>::</span><span class='RACK constant id'>RACK</span><span class='comma token'>,</span>
               <span class='string val'>&quot;rack.input&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rack_input identifier id'>rack_input</span><span class='comma token'>,</span>
               <span class='string val'>&quot;rack.errors&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='$stderr gvar id'>$stderr</span><span class='comma token'>,</span>

               <span class='string val'>&quot;rack.multithread&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span><span class='comma token'>,</span>
               <span class='string val'>&quot;rack.multiprocess&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='false false kw'>false</span><span class='comma token'>,</span>
               <span class='string val'>&quot;rack.run_once&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='false false kw'>false</span><span class='comma token'>,</span>

               <span class='string val'>&quot;rack.url_scheme&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;http&quot;</span><span class='comma token'>,</span>
             <span class='rbrace token'>}</span> <span class='rparen token'>)</span>

  <span class='comment val'># g env.inspect if Logging.debug?</span>
  <span class='status identifier id'>status</span><span class='comma token'>,</span> <span class='headers identifier id'>headers</span><span class='comma token'>,</span> <span class='body identifier id'>body</span> <span class='assign token'>=</span> <span class='@app ivar id'>@app</span><span class='dot token'>.</span><span class='call identifier id'>call</span><span class='lparen token'>(</span><span class='env identifier id'>env</span><span class='rparen token'>)</span>
  <span class='comment val'># g body.inspect if (Logging.debug? and body)</span>
  <span class='comment val'># g status.inspect if (Logging.debug? and status)</span>
  <span class='raise identifier id'>raise</span> <span class='RackParseError constant id'>RackParseError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;status is a #{status.class} class, not an integer&quot;</span> <span class='unless unless_mod kw'>unless</span> <span class='status identifier id'>status</span><span class='dot token'>.</span><span class='is_a? fid id'>is_a?</span><span class='lparen token'>(</span><span class='Integer constant id'>Integer</span><span class='rparen token'>)</span>
  <span class='raise identifier id'>raise</span> <span class='RackParseError constant id'>RackParseError</span><span class='comma token'>,</span> <span class='string val'>&quot;body doesn't respond to :each and return strings&quot;</span> <span class='unless unless_mod kw'>unless</span> <span class='body identifier id'>body</span><span class='dot token'>.</span><span class='respond_to? fid id'>respond_to?</span><span class='lparen token'>(</span><span class='symbol val'>:each</span><span class='rparen token'>)</span>

  <span class='resp identifier id'>resp</span> <span class='assign token'>=</span> <span class='DefaultHttpResponse constant id'>DefaultHttpResponse</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span> <span class='HttpVersion constant id'>HttpVersion</span><span class='colon2 op'>::</span><span class='HTTP_1_1 constant id'>HTTP_1_1</span><span class='comma token'>,</span> <span class='HttpResponseStatus constant id'>HttpResponseStatus</span><span class='dot token'>.</span><span class='value_of identifier id'>value_of</span><span class='lparen token'>(</span> <span class='status identifier id'>status</span> <span class='rparen token'>)</span> <span class='rparen token'>)</span>
  <span class='headers identifier id'>headers</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='k identifier id'>k</span><span class='comma token'>,</span><span class='vs identifier id'>vs</span><span class='bitor op'>|</span>
    <span class='vs identifier id'>vs</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='v identifier id'>v</span><span class='bitor op'>|</span> <span class='resp identifier id'>resp</span><span class='dot token'>.</span><span class='add_header identifier id'>add_header</span> <span class='k identifier id'>k</span><span class='comma token'>,</span> <span class='v identifier id'>v</span><span class='dot token'>.</span><span class='chomp identifier id'>chomp</span> <span class='rbrace token'>}</span> <span class='if if_mod kw'>if</span> <span class='vs identifier id'>vs</span>
  <span class='end end kw'>end</span> <span class='if if_mod kw'>if</span> <span class='headers identifier id'>headers</span>
  <span class='out_buf identifier id'>out_buf</span> <span class='assign token'>=</span> <span class='ChannelBuffers constant id'>ChannelBuffers</span><span class='dot token'>.</span><span class='dynamic_buffer identifier id'>dynamic_buffer</span>
  <span class='body identifier id'>body</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='line identifier id'>line</span><span class='bitor op'>|</span>
    <span class='out_buf identifier id'>out_buf</span><span class='dot token'>.</span><span class='write_bytes identifier id'>write_bytes</span> <span class='ChannelBuffers constant id'>ChannelBuffers</span><span class='dot token'>.</span><span class='copied_buffer identifier id'>copied_buffer</span><span class='lparen token'>(</span> <span class='line identifier id'>line</span><span class='comma token'>,</span> <span class='string val'>&quot;UTF-8&quot;</span> <span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
  <span class='resp identifier id'>resp</span><span class='dot token'>.</span><span class='content identifier id'>content</span> <span class='assign token'>=</span> <span class='out_buf identifier id'>out_buf</span>
  <span class='comment val'># g resp.inspect if Logging.debug?</span>
  <span class='resp identifier id'>resp</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Mon Dec 07 10:45:19 2009 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool">yard</a>
  0.4.0 (ruby-1.8.7).
</div>

  </body>
</html>